{% extends 'base.html' %}
{% load static %}

{% block title %}Posts - PostPro{% endblock %}

{% block sidebar %}
{% include 'components/sidebar.html' %}
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">Posts</h1>
    </div>

    <div class="card mb-6">
        <div class="card-body">
            <form method="get" class="flex gap-4 items-end flex-wrap">
                <div class="form-group mb-0" style="min-width: 200px;">
                    <label class="form-label">Projeto</label>
                    <select name="project" class="form-select" onchange="this.form.submit()">
                        <option value="">Todos os projetos</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}" {% if project_filter == project.id|stringformat:'s' %}selected{% endif %}>{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group mb-0" style="min-width: 150px;">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select" onchange="this.form.submit()">
                        <option value="">Todos</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group mb-0 flex-1" style="min-width: 200px;">
                    <label class="form-label">Buscar</label>
                    <input type="text" name="search" class="form-input" value="{{ search }}" placeholder="Keyword ou título..." data-search>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Keyword</th>
                        <th>Título</th>
                        <th>Projeto</th>
                        <th>Status</th>
                        <th>Custo</th>
                        <th>Data</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for post in posts %}
                    <tr>
                        <td><strong>{{ post.keyword|truncatewords:5 }}</strong></td>
                        <td>{{ post.title|truncatewords:8|default:'-' }}</td>
                        <td>{{ post.project.name }}</td>
                        <td><span class="badge badge-{% if post.status == 'published' %}success{% elif post.status == 'pending_review' %}warning{% elif post.status == 'failed' %}error{% elif post.status == 'generating' %}info{% else %}gray{% endif %}">{{ post.get_status_display }}</span></td>
                        <td>${{ post.total_cost|floatformat:4 }}</td>
                        <td class="text-muted">{{ post.created_at|date:"d/m H:i" }}</td>
                        <td>
                            <div class="flex gap-1">
                                <button class="btn btn-ghost btn-sm" onclick="openPostModal('{{ post.id }}')" title="Preview">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                </button>
                                {% if post.status == 'pending_review' or post.status == 'approved' %}
                                <button class="btn btn-ghost btn-sm" onclick="publishPost('{{ post.id }}')" title="Publicar">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                                </button>
                                {% endif %}
                                {% if post.wordpress_edit_url %}
                                <a href="{{ post.wordpress_edit_url }}" target="_blank" class="btn btn-ghost btn-sm" title="Editar no WP">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                <h3 class="empty-state-title">Nenhum post encontrado</h3>
                                <p class="empty-state-text">Faça upload de um CSV para gerar posts.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if posts.has_other_pages %}
        <div class="card-footer">
            <div class="flex justify-center gap-2">
                {% if posts.has_previous %}
                <a href="?page={{ posts.previous_page_number }}&project={{ project_filter }}&status={{ status_filter }}&search={{ search }}" class="btn btn-secondary btn-sm">Anterior</a>
                {% endif %}
                <span class="btn btn-ghost btn-sm">Página {{ posts.number }} de {{ posts.paginator.num_pages }}</span>
                {% if posts.has_next %}
                <a href="?page={{ posts.next_page_number }}&project={{ project_filter }}&status={{ status_filter }}&search={{ search }}" class="btn btn-secondary btn-sm">Próxima</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="modal-backdrop" id="post-modal">
    <div class="modal" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Preview do Post</h3>
            <button class="modal-close" onclick="closeModal('post-modal')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="modal-body" id="modal-body">
            <div class="spinner" style="margin: 2rem auto;"></div>
        </div>
        <div class="modal-footer" id="modal-footer"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function openPostModal(postId) {
        openModal('post-modal');
        try {
            const response = await fetch('/automation/posts/' + postId + '/');
            const html = await response.text();
            document.getElementById('modal-body').innerHTML = html;
        } catch (error) {
            document.getElementById('modal-body').innerHTML = '<div class="alert alert-error">Erro ao carregar post: ' + error.message + '</div>';
        }
    }

    async function publishPost(postId) {
        if (!confirm('Publicar este post no WordPress?')) return;
        try {
            const response = await fetch('/automation/posts/' + postId + '/publish/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
            });
            const data = await response.json();
            if (data.success) {
                showToast('Publicando...', 'info');
                setTimeout(function() { location.reload(); }, 2000);
            } else {
                showToast(data.message || 'Erro', 'error');
            }
        } catch (error) {
            showToast('Erro: ' + error.message, 'error');
        }
    }

    async function regenerateStep(postId, step) {
        if (!confirm('Regenerar ' + step + '?')) return;
        try {
            const response = await fetch('/automation/posts/' + postId + '/regenerate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ step: step }),
            });
            const data = await response.json();
            showToast(data.message, data.success ? 'info' : 'error');
            if (data.success) {
                setTimeout(function() { openPostModal(postId); }, 2000);
            }
        } catch (error) {
            showToast('Erro: ' + error.message, 'error');
        }
    }
</script>
{% endblock %}
