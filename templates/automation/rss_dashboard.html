{% extends 'base.html' %}

{% block title %}Dashboard RSS | PostPro{% endblock %}

{% block content %}
<div class="page-header flex justify-between items-center mb-6">
    <h1 class="page-title">üì∞ Dashboard de Not√≠cias (RSS)</h1>
    <div class="page-actions">
        <!-- Optional Actions -->
    </div>
</div>

<!-- Metrics Cards -->
<div class="grid-3 mb-8 gap-6">
    <div class="card p-4">
        <div class="text-sm text-muted uppercase font-bold">Total de Feeds</div>
        <div class="text-3xl font-bold mt-2">{{ total_feeds }}</div>
        <div class="text-sm text-green-600 mt-1">
            {{ active_feeds }} ativos
        </div>
    </div>
    <div class="card p-4">
        <div class="text-sm text-muted uppercase font-bold">Processados Hoje</div>
        <div class="text-3xl font-bold mt-2">{{ processed_today }}</div>
        <div class="text-sm text-muted mt-1">Not√≠cias convertidas (Global)</div>
    </div>
    <div class="card p-4">
        <div class="text-sm text-muted uppercase font-bold">√öltima Atividade</div>
        <div class="text-xl font-bold mt-2">
            {% if recent_items %}{{ recent_items.0.created_at|date:"H:i" }}{% else %}-{% endif %}
        </div>
        <div class="text-sm text-muted mt-1 truncate">
            {% if recent_items %}{{ recent_items.0.project.name }}{% else %}Sem atividades{% endif %}
        </div>
    </div>
</div>

<div class="grid lg:grid-cols-3 gap-6">
    <!-- Recent News Stream -->
    <div class="card lg:col-span-2">
        <div class="card-header">
            <h3 class="card-title">Fluxo de Not√≠cias Recentes</h3>
        </div>
        <div class="card-body p-0">
            {% if recent_items %}
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="p-3">Data</th>
                            <th class="p-3">Projeto</th>
                            <th class="p-3">T√≠tulo / Fonte</th>
                            <th class="p-3">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        {% for item in recent_items %}
                        <tr class="hover:bg-gray-50">
                            <td class="p-3 whitespace-nowrap text-muted">
                                {{ item.created_at|date:"d/m H:i" }}
                            </td>
                            <td class="p-3">
                                <a href="{% url 'projects:detail' item.project.id %}"
                                    class="badge badge-primary no-underline text-xs">
                                    {{ item.project.name }}
                                </a>
                            </td>
                            <td class="p-3">
                                <div class="font-bold truncate max-w-xs md:max-w-md" title="{{ item.source_title }}">
                                    <a href="{{ item.source_url }}" target="_blank" rel="noopener"
                                        class="hover:text-blue-600">{{ item.source_title }}</a>
                                </div>
                                <div class="text-xs text-muted flex gap-2 mt-1">
                                    <span>{{ item.source_hash|slice:":8" }}</span>
                                    <span>‚Ä¢</span>
                                    <span
                                        class="{% if item.status == 'PROCESSED' %}text-green-600{% elif item.status == 'FAILED' %}text-red-600{% else %}text-yellow-600{% endif %}">{{
                                        item.get_status_display }}</span>
                                </div>
                            </td>
                            <td class="p-3">
                                {% if item.post %}
                                <a href="#" onclick="alert('Post ID: {{ item.post.id }}')"
                                    class="btn btn-xs btn-outline">Ver Post</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-8 text-center text-muted">
                Nenhuma not√≠cia processada recentemente.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Feeds Status -->
    <div class="card h-fit">
        <div class="card-header">
            <h3 class="card-title">Status dos Feeds</h3>
        </div>
        <div class="card-body p-0">
            {% if feeds %}
            <ul class="divide-y max-h-[600px] overflow-y-auto">
                {% for feed in feeds %}
                <li class="p-3 hover:bg-gray-50 flex justify-between items-center group">
                    <div class="overflow-hidden pr-2">
                        <div class="font-bold text-sm truncate" title="{{ feed.name|default:feed.feed_url }}">{{
                            feed.name|default:feed.feed_url }}</div>
                        <div class="text-xs text-muted flex items-center gap-1">
                            <a href="{% url 'projects:detail' feed.project.id %}" class="hover:underline">{{
                                feed.project.name }}</a>
                        </div>
                    </div>
                    <div class="text-right whitespace-nowrap ml-2 flex-shrink-0">
                        <div
                            class="text-xs font-bold {% if feed.is_active %}text-green-600{% else %}text-gray-400{% endif %}">
                            {% if feed.is_active %}‚óè Ativo{% else %}‚óã Inativo{% endif %}
                        </div>
                        <div class="text-xs text-muted mt-0.5" title="√öltima checagem">
                            {{ feed.last_checked_at|date:"H:i"|default:"-" }}
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="p-4 text-center text-muted text-sm">
                Nenhum feed cadastrado.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}