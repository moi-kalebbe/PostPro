{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - {{ agency_name }}{% endblock %}

{% block sidebar %}
{% include 'components/sidebar.html' %}
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">Dashboard</h1>
        <a href="{% url 'projects:create' %}" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Novo Projeto
        </a>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="card">
            <div class="card-body stat-card">
                <span class="stat-label">Total de Projetos</span>
                <span class="stat-value">{{ total_projects }}</span>
            </div>
        </div>

        <div class="card">
            <div class="card-body stat-card">
                <span class="stat-label">Posts Gerados</span>
                <span class="stat-value">{{ total_posts }}</span>
            </div>
        </div>

        <div class="card">
            <div class="card-body stat-card">
                <span class="stat-label">Posts Publicados</span>
                <span class="stat-value text-success">{{ published_posts }}</span>
            </div>
        </div>

        <div class="card">
            <div class="card-body stat-card">
                <span class="stat-label">Custo Total</span>
                <span class="stat-value">${{ total_cost|floatformat:4 }}</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-6 mb-6">
        <!-- Posts Chart -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Posts por Dia</h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                    <canvas id="postsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Costs Chart -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Custos por Dia</h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                    <canvas id="costsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Step Breakdown -->
    <div class="card mb-6">
        <div class="card-header">
            <h3 class="card-title">Custo por Etapa</h3>
        </div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Etapa</th>
                        <th class="text-right">Execuções</th>
                        <th class="text-right">Custo</th>
                        <th class="text-right">% do Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in step_costs %}
                    <tr>
                        <td>
                            <span
                                class="badge badge-{% if s.step == 'research' %}info{% elif s.step == 'strategy' %}warning{% elif s.step == 'article' %}success{% else %}gray{% endif %}">
                                {{ s.step|title }}
                            </span>
                        </td>
                        <td class="text-right">{{ s.count }}</td>
                        <td class="text-right font-medium">${{ s.total_cost|floatformat:3 }}</td>
                        <td class="text-right text-muted">
                            {% if total_cost > 0 %}
                            {% widthratio s.total_cost total_cost 100 %}%
                            {% else %}
                            0%
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center p-4">Sem dados</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Posts -->
    <div class="card mt-6">
        <div class="card-header">
            <h3 class="card-title">Posts Recentes</h3>
            <a href="{% url 'automation:posts_list' %}" class="btn btn-ghost btn-sm">Ver todos</a>
        </div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Keyword</th>
                        <th>Projeto</th>
                        <th>Status</th>
                        <th>Custo</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody>
                    {% for post in recent_posts %}
                    <tr>
                        <td>
                            <strong>{{ post.keyword|truncatewords:5 }}</strong>
                        </td>
                        <td>{{ post.project.name }}</td>
                        <td>
                            <span
                                class="badge badge-{% if post.status == 'published' %}success{% elif post.status == 'pending_review' %}warning{% elif post.status == 'failed' %}error{% else %}info{% endif %}">
                                {{ post.get_status_display }}
                            </span>
                        </td>
                        <td>${{ post.total_cost|floatformat:4 }}</td>
                        <td class="text-muted">{{ post.created_at|date:"d/m/Y H:i" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted p-6">
                            Nenhum post gerado ainda
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        try {
            // Prepare Data
            var postsRaw = JSON.parse('{{ posts_chart_data|escapejs }}');
            var costsRaw = JSON.parse('{{ costs_chart_data|escapejs }}');

            console.log("Initializing Dashboard Charts...");
            console.log("Posts Data:", postsRaw);

            // Common Chart Options
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        ticks: { color: '#888' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#888' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            };

            // Render Posts Chart
            var ctxPosts = document.getElementById('postsChart');
            if (ctxPosts) {
                if (postsRaw && postsRaw.length > 0) {
                    new Chart(ctxPosts, {
                        type: 'line',
                        data: {
                            labels: postsRaw.map(function (d) { return d.date; }),
                            datasets: [{
                                label: 'Posts',
                                data: postsRaw.map(function (d) { return d.count; }),
                                borderColor: '#FF6B2C',
                                backgroundColor: 'rgba(255, 107, 44, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: commonOptions
                    });
                } else {
                    ctxPosts.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-muted">Sem dados de posts (0)</div>';
                }
            }

            // Render Costs Chart
            var ctxCosts = document.getElementById('costsChart');
            if (ctxCosts) {
                if (costsRaw && costsRaw.length > 0) {
                    new Chart(ctxCosts, {
                        type: 'bar',
                        data: {
                            labels: costsRaw.map(function (d) { return d.date; }),
                            datasets: [{
                                label: 'Custo ($)',
                                data: costsRaw.map(function (d) { return d.cost; }),
                                backgroundColor: '#FF6B2C',
                                borderRadius: 4
                            }]
                        },
                        options: commonOptions
                    });
                } else {
                    ctxCosts.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-muted">Sem dados de custos (0)</div>';
                }
            }
        } catch (e) {
            console.error("Dashboard Chart Error:", e);
            document.querySelector('.grid.grid-cols-2').innerHTML += '<div class="col-span-2 p-4 bg-red-100 text-red-500 rounded">Erro no JS: ' + e.message + '</div>';
        }
    });
</script>
{% endblock %}