{% extends 'base.html' %}
{% load static %}

{% block title %}Batch Upload - {{ project.name }} - PostPro{% endblock %}

{% block sidebar %}
{% include 'components/sidebar.html' %}
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div>
            <h1 class="page-title">Upload de Keywords</h1>
            <p class="text-muted">{{ project.name }}</p>
        </div>
    </div>

    <div class="card" style="max-width: 900px;">
        <div class="card-body">
            <!-- Wizard Steps -->
            <div class="wizard mb-8">
                <div class="wizard-step active" id="step-indicator-1">
                    <span class="wizard-number">1</span>
                    <span>Upload</span>
                </div>
                <div class="wizard-line"></div>
                <div class="wizard-step" id="step-indicator-2">
                    <span class="wizard-number">2</span>
                    <span>Opções</span>
                </div>
                <div class="wizard-line"></div>
                <div class="wizard-step" id="step-indicator-3">
                    <span class="wizard-number">3</span>
                    <span>Processando</span>
                </div>
                <div class="wizard-line"></div>
                <div class="wizard-step" id="step-indicator-4">
                    <span class="wizard-number">4</span>
                    <span>Concluído</span>
                </div>
            </div>

            <!-- Step 1: File Upload -->
            <div id="step-1" class="wizard-content">
                <h2 class="mb-4">Enviar arquivo CSV ou XLSX</h2>

                <div class="file-upload" id="file-upload-area">
                    <input type="file" id="csv-file" accept=".csv,.xlsx" hidden>
                    <svg class="file-upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <p class="file-upload-text">Clique ou arraste seu arquivo aqui</p>
                    <p class="file-upload-hint">Suporta CSV e XLSX. Coluna: keyword, keywords, ou primeira coluna.</p>
                </div>

                <div class="mt-6 flex justify-end">
                    <button class="btn btn-primary" id="btn-next-1" disabled>
                        Próximo
                    </button>
                </div>
            </div>

            <!-- Step 2: Options -->
            <div id="step-2" class="wizard-content" hidden>
                <h2 class="mb-4">Configurações do Batch</h2>

                <div class="grid grid-cols-2" style="gap: 1.5rem;">
                    <div class="form-group">
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="opt-images" class="form-checkbox" checked>
                            <span>Gerar imagens de destaque</span>
                        </label>
                        <span class="form-help">Imagens são geradas via OpenRouter</span>
                    </div>

                    <div class="form-group">
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="opt-publish" class="form-checkbox">
                            <span>Publicar automaticamente</span>
                        </label>
                        <span class="form-help">Publica direto no WordPress</span>
                    </div>

                    <div class="form-group">
                        <label class="flex items-center gap-3">
                            <input type="checkbox" id="opt-dryrun" class="form-checkbox">
                            <span class="font-medium">Modo Simulação (Dry-Run)</span>
                        </label>
                        <span class="form-help">Estima custos sem gerar conteúdo</span>
                    </div>
                </div>

                <div class="alert alert-info mt-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <div>
                        <strong>Dica:</strong> Use o modo simulação primeiro para verificar custos estimados antes de
                        processar.
                    </div>
                </div>

                <div class="mt-6 flex justify-between">
                    <button class="btn btn-secondary" id="btn-back-2">Voltar</button>
                    <button class="btn btn-primary" id="btn-start">
                        Iniciar Processamento
                    </button>
                </div>
            </div>

            <!-- Step 3: Processing -->
            <div id="step-3" class="wizard-content" hidden>
                <h2 class="mb-4">Processando...</h2>

                <div class="text-center p-6">
                    <div class="spinner" style="width: 48px; height: 48px; margin: 0 auto 1.5rem;"></div>
                    <p class="text-lg mb-2" id="progress-text">Iniciando...</p>
                    <div class="progress mb-2" style="max-width: 400px; margin: 0 auto;">
                        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-muted" id="progress-detail">0 / 0 keywords</p>
                </div>
            </div>

            <!-- Step 4: Complete -->
            <div id="step-4" class="wizard-content" hidden>
                <div class="text-center p-6">
                    <svg class="empty-state-icon" style="color: var(--color-success);"
                        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <h2 class="mt-4 mb-2" id="complete-title">Processamento Concluído!</h2>
                    <p class="text-muted mb-6" id="complete-message">Seus posts foram gerados com sucesso.</p>

                    <div id="simulation-results" class="card mb-6" hidden>
                        <div class="card-header">
                            <h3 class="card-title">Resultado da Simulação</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-3" style="gap: 1rem;">
                                <div class="stat-card">
                                    <span class="stat-label">Posts</span>
                                    <span class="stat-value" id="sim-posts">0</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-label">Tokens Est.</span>
                                    <span class="stat-value" id="sim-tokens">0</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-label">Custo Est.</span>
                                    <span class="stat-value text-primary" id="sim-cost">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-center gap-4">
                        <a href="{% url 'automation:posts_list' %}?project={{ project.id }}" class="btn btn-primary">
                            Ver Posts
                        </a>
                        <a href="{% url 'projects:batch_upload' project.id %}" class="btn btn-secondary">
                            Novo Upload
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const projectId = '{{ project.id }}';
        let selectedFile = null;
        let batchId = null;

        // File input
        const fileInput = document.getElementById('csv-file');
        const uploadArea = document.getElementById('file-upload-area');
        const btnNext1 = document.getElementById('btn-next-1');

        fileInput.addEventListener('change', function () {
            if (this.files.length) {
                selectedFile = this.files[0];
                uploadArea.querySelector('.file-upload-text').textContent = selectedFile.name;
                uploadArea.classList.add('has-file');
                btnNext1.disabled = false;
            }
        });

        // Step navigation
        function showStep(step) {
            document.querySelectorAll('.wizard-content').forEach(el => el.hidden = true);
            document.getElementById(`step-${step}`).hidden = false;

            document.querySelectorAll('.wizard-step').forEach((el, i) => {
                el.classList.remove('active', 'completed');
                if (i + 1 < step) el.classList.add('completed');
                if (i + 1 === step) el.classList.add('active');
            });
        }

        btnNext1.addEventListener('click', () => showStep(2));
        document.getElementById('btn-back-2').addEventListener('click', () => showStep(1));

        // Start processing
        document.getElementById('btn-start').addEventListener('click', async function () {
            showStep(3);

            const formData = new FormData();
            formData.append('csv_file', selectedFile);
            formData.append('generate_images', document.getElementById('opt-images').checked);
            formData.append('auto_publish', document.getElementById('opt-publish').checked);
            formData.append('dry_run', document.getElementById('opt-dryrun').checked);

            try {
                const response = await fetch(`/automation/projects/${projectId}/batch-upload/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                });

                const data = await response.json();

                if (data.success) {
                    batchId = data.batch_id;
                    pollStatus();
                } else {
                    showToast(data.message || 'Error starting batch', 'error');
                    showStep(2);
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                showStep(2);
            }
        });

        // Poll status
        async function pollStatus() {
            if (!batchId) return;

            try {
                const response = await fetch(`/automation/batches/${batchId}/status/`);
                const data = await response.json();

                document.getElementById('progress-text').textContent =
                    data.status === 'processing' ? 'Processando...' :
                        data.status === 'completed' ? 'Concluído!' : data.status;

                document.getElementById('progress-bar').style.width = `${data.progress_percent}%`;
                document.getElementById('progress-detail').textContent =
                    `${data.processed_rows} / ${data.total_rows} keywords`;

                if (data.status === 'completed') {
                    showStep(4);

                    if (data.is_dry_run && data.error_log?.simulation_report) {
                        const sim = data.error_log.simulation_report;
                        document.getElementById('complete-title').textContent = 'Simulação Concluída!';
                        document.getElementById('complete-message').textContent = 'Veja os custos estimados abaixo.';
                        document.getElementById('simulation-results').hidden = false;
                        document.getElementById('sim-posts').textContent = sim.total_posts;
                        document.getElementById('sim-tokens').textContent = formatNumber(sim.total_tokens);
                        document.getElementById('sim-cost').textContent = '$' + parseFloat(sim.total_cost).toFixed(4);
                    }
                } else if (data.status === 'failed') {
                    showStep(4);
                    document.getElementById('complete-title').textContent = 'Erro no Processamento';
                    document.getElementById('complete-message').textContent = data.error || 'Erro desconhecido';
                } else {
                    setTimeout(pollStatus, 2000);
                }
            } catch (error) {
                console.error('Polling error:', error);
                setTimeout(pollStatus, 3000);
            }
        }

        function formatNumber(n) {
            return new Intl.NumberFormat().format(n);
        }
    });
</script>
{% endblock %}